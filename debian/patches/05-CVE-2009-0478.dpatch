#! /bin/sh /usr/share/dpatch/dpatch-run

@DPATCH@
--- ../old/squid3-3.0.PRE5/src/HttpMsg.cc	2006-10-02 12:08:20.000000000 +0000
+++ squid3-3.0.PRE5/src/HttpMsg.cc	2009-03-02 01:11:14.000000000 +0000
@@ -462,7 +462,7 @@
 {
 	int i = 0;
 	int retcode = 0;
-	int maj = -1, min = -1;
+	unsigned int maj = 0, min = 0;
 	int last_whitespace = -1, line_end = -1;
 
 	debug(74, 5)("httpParserParseReqLine: parsing %s\n", hmsg->buf);
@@ -567,10 +567,14 @@
 
 			/* next should be 1 or more digits */
 			maj = 0;
-			for (; i < hmsg->req_end && (isdigit(hmsg->buf[i])); i++) {
+			for (; i < hmsg->req_end && (isdigit(hmsg->buf[i])) && maj < 65536; i++) {
 				maj = maj * 10;
 				maj = maj + (hmsg->buf[i]) - '0';
 			}
+                        if (maj >= 65536) {
+                            retcode = -1;
+                            goto finish;
+                        }
 			if (i >= hmsg->req_end) {
 				retcode = 0;
 				goto finish;
@@ -589,10 +593,14 @@
 			/* next should be one or more digits */
 			i++;
 			min = 0;
-			for (; i < hmsg->req_end && (isdigit(hmsg->buf[i])); i++) {
+			for (; i < hmsg->req_end && (isdigit(hmsg->buf[i])) && min < 65536; i++) {
 				min = min * 10;
 				min = min + (hmsg->buf[i]) - '0';
 			}
+                        if (min >= 65536) {
+                            retcode = -1;
+                            goto finish;
+                        }
 
 			/* Find whitespace, end of version */
 			hmsg->v_end = i;
@@ -604,8 +612,6 @@
 	 * Rightio - we have all the schtuff. Return true; we've got enough.
 	 */
 	retcode = 1;
-	assert(maj != -1);
-	assert(min != -1);
 
 finish:
 	hmsg->v_maj = maj;
