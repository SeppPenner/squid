#! /bin/sh /usr/share/dpatch/dpatch-run
## 17-CVE-2010-2951.dpatch by Stephen Thorne <stephen@thorne.id.au>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: Bug 3021: Large DNS reply causes crash when no ipv6 resolver present

@DPATCH@

--- a/src/dns_internal.cc
+++ b/src/dns_internal.cc
@@ -843,14 +843,16 @@
 
     } while ( (x<0 && y<0) && q->nsends % nns != 0);
 
-    if (y >= 0) {
-        fd_bytes(DnsSocketB, y, FD_WRITE);
-        commSetSelect(DnsSocketB, COMM_SELECT_READ, idnsRead, NULL, 0);
-    }
+    if (!q->need_vc) {
+        if (y >= 0) {
+            fd_bytes(DnsSocketB, y, FD_WRITE);
+            commSetSelect(DnsSocketB, COMM_SELECT_READ, idnsRead, NULL, 0);
+        }
 
-    if (x >= 0) {
-        fd_bytes(DnsSocketA, x, FD_WRITE);
-        commSetSelect(DnsSocketA, COMM_SELECT_READ, idnsRead, NULL, 0);
+        if (x >= 0) {
+            fd_bytes(DnsSocketA, x, FD_WRITE);
+            commSetSelect(DnsSocketA, COMM_SELECT_READ, idnsRead, NULL, 0);
+        }
     }
 
     nameservers[ns].nqueries++;
